name: Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Start Nacos test environment
      run: docker compose up -d

    - name: Wait for Nacos to be ready
      run: |
        echo "=== 等待 Nacos 服务启动 ==="
        for i in {1..12}; do
          if curl -s http://localhost:8848/nacos/v1/console/health/readiness > /dev/null 2>&1 && \
             curl -s http://localhost:8849/nacos/v1/console/health/readiness > /dev/null 2>&1; then
            echo "Nacos 服务已就绪"
            break
          fi
          echo "等待中... ($i/12)"
          sleep 5
        done

    - name: Initialize admin password for auth mode
      run: |
        echo "=== 初始化认证模式管理员密码 ==="
        # Nacos 2.4.0+ 需要通过 API 初始化管理员密码
        INIT_RESULT=$(curl -s -X POST 'http://localhost:8849/nacos/v1/auth/users/admin' -d 'password=nacos')
        echo "初始化结果: $INIT_RESULT"

        # 验证初始化成功
        if echo "$INIT_RESULT" | grep -q '"username":"nacos"'; then
          echo "✓ 管理员密码初始化成功"
        else
          echo "✗ 管理员密码初始化失败"
          exit 1
        fi

        # 验证可以登录
        echo "=== 验证登录 ==="
        LOGIN_RESULT=$(curl -s -X POST 'http://localhost:8849/nacos/v1/auth/login' -d 'username=nacos&password=nacos')
        if echo "$LOGIN_RESULT" | grep -q 'accessToken'; then
          echo "✓ 登录验证成功"
        else
          echo "✗ 登录验证失败"
          exit 1
        fi

    - name: Build nacosctl
      run: CGO_ENABLED=0 go build -o nacosctl .

    - name: Test without authentication (port 8848)
      run: |
        echo "=== 测试无认证模式 ==="
        export NACOS_ADDR="http://localhost:8848/nacos"

        # 1. 创建配置
        echo "  → 创建配置 test-no-auth.yaml"
        echo "app.name: test-no-auth" > test-no-auth.yaml
        ./nacosctl apply config --file test-no-auth.yaml -n public
        if [ $? -ne 0 ]; then echo "✗ 创建配置失败"; exit 1; fi
        echo "  ✓ 创建配置成功"

        # 2. 等待配置同步
        echo "  → 等待配置同步"
        sleep 2

        # 3. 获取配置
        echo "  → 获取配置"
        CONTENT=$(./nacosctl get config test-no-auth.yaml -n public)
        if echo "$CONTENT" | grep -q "test-no-auth"; then
          echo "  ✓ 获取配置成功，内容正确"
        else
          echo "✗ 获取配置失败或内容不匹配"
          exit 1
        fi

        # 4. 列出所有配置
        echo "  → 列出所有配置"
        ./nacosctl get config -A -n public | tee /tmp/list-no-auth.txt
        if grep -q "test-no-auth.yaml" /tmp/list-no-auth.txt; then
          echo "  ✓ 列出配置成功"
        else
          echo "✗ 列出配置失败"
          exit 1
        fi

        # 5. 删除配置
        echo "  → 删除配置"
        ./nacosctl delete config test-no-auth.yaml -n public
        if [ $? -eq 0 ]; then
          echo "  ✓ 删除配置成功"
        else
          echo "✗ 删除配置失败"
          exit 1
        fi

        # 6. 验证删除
        echo "  → 验证删除"
        OUTPUT=$(./nacosctl get config test-no-auth.yaml -n public 2>&1 || true)
        if echo "$OUTPUT" | grep -q "config data not exist"; then
          echo "  ✓ 验证删除成功"
        else
          echo "✗ 验证删除失败"
          exit 1
        fi

        echo "✓ 无认证模式测试通过"

    - name: Test with authentication (port 8849)
      run: |
        echo "=== 测试带认证模式 ==="
        export NACOS_ADDR="http://localhost:8849/nacos"
        export NACOS_USERNAME="nacos"
        export NACOS_PASSWORD="nacos"

        # 1. 创建配置
        echo "  → 创建配置 test-with-auth.yaml"
        echo "app.name: test-with-auth" > test-with-auth.yaml
        ./nacosctl apply config --file test-with-auth.yaml -n public
        if [ $? -ne 0 ]; then echo "✗ 创建配置失败"; exit 1; fi
        echo "  ✓ 创建配置成功"

        # 2. 等待配置同步
        echo "  → 等待配置同步"
        sleep 2

        # 3. 获取配置
        echo "  → 获取配置"
        CONTENT=$(./nacosctl get config test-with-auth.yaml -n public)
        if echo "$CONTENT" | grep -q "test-with-auth"; then
          echo "  ✓ 获取配置成功，内容正确"
        else
          echo "✗ 获取配置失败或内容不匹配"
          exit 1
        fi

        # 4. 列出所有配置
        echo "  → 列出所有配置"
        ./nacosctl get config -A -n public | tee /tmp/list-with-auth.txt
        if grep -q "test-with-auth.yaml" /tmp/list-with-auth.txt; then
          echo "  ✓ 列出配置成功"
        else
          echo "✗ 列出配置失败"
          exit 1
        fi

        # 5. 创建不同类型的配置
        echo "  → 测试不同文件类型"

        # JSON 类型
        echo '{"key": "value"}' > test.json
        ./nacosctl apply config --file test.json -n public
        if [ $? -eq 0 ]; then
          echo "  ✓ JSON 类型配置创建成功"
        else
          echo "✗ JSON 类型配置创建失败"
          exit 1
        fi

        # Properties 类型
        echo "key=value" > test.properties
        ./nacosctl apply config --file test.properties -n public
        if [ $? -eq 0 ]; then
          echo "  ✓ Properties 类型配置创建成功"
        else
          echo "✗ Properties 类型配置创建失败"
          exit 1
        fi

        # 6. 删除配置
        echo "  → 删除配置"
        ./nacosctl delete config test-with-auth.yaml -n public
        ./nacosctl delete config test.json -n public
        ./nacosctl delete config test.properties -n public
        echo "  ✓ 删除配置成功"

        # 7. 验证 Token 缓存
        echo "  → 验证 Token 缓存"
        if ls ~/.nacosctl/token_*.json 2>/dev/null | grep -q .; then
          echo "  ✓ Token 缓存文件存在"
        else
          echo "✗ Token 缓存文件不存在"
          exit 1
        fi

        echo "✓ 带认证模式测试通过"

    - name: Test token cache and refresh
      run: |
        echo "=== 测试 Token 缓存和刷新机制 ==="
        export NACOS_ADDR="http://localhost:8849/nacos"
        export NACOS_USERNAME="nacos"
        export NACOS_PASSWORD="nacos"

        # 清除之前的缓存
        echo "  → 清除旧缓存"
        rm -rf ~/.nacosctl/
        mkdir -p ~/.nacosctl/

        # 第一次请求会生成 token
        echo "  → 第一次请求（生成 token）"
        ./nacosctl get config -A -n public > /dev/null
        if [ $? -ne 0 ]; then echo "✗ 首次请求失败"; exit 1; fi
        echo "  ✓ 首次请求成功"

        # 检查缓存文件已创建
        echo "  → 检查缓存文件"
        CACHE_FILE=$(ls ~/.nacosctl/token_*.json 2>/dev/null | head -1)
        if [ -z "$CACHE_FILE" ]; then
          echo "✗ Token 缓存未创建"
          exit 1
        fi
        echo "  ✓ 缓存文件: $(basename $CACHE_FILE)"

        # 验证缓存文件内容
        echo "  → 验证缓存内容"
        if cat "$CACHE_FILE" | grep -q "accessToken"; then
          echo "  ✓ Token 缓存内容有效"
        else
          echo "✗ Token 缓存内容无效"
          exit 1
        fi

        # 第二次请求应该使用缓存
        echo "  → 第二次请求（使用缓存）"
        ./nacosctl get config -A -n public > /dev/null
        if [ $? -ne 0 ]; then echo "✗ 使用缓存请求失败"; exit 1; fi
        echo "  ✓ 缓存请求成功"

        echo "✓ Token 缓存测试通过"

    - name: Test different namespaces and groups
      run: |
        echo "=== 测试不同命名空间和分组 ==="
        export NACOS_ADDR="http://localhost:8849/nacos"
        export NACOS_USERNAME="nacos"
        export NACOS_PASSWORD="nacos"

        # 测试不同分组
        echo "  → 测试不同分组"
        echo "group: PROD_GROUP" > test-prod.yaml
        ./nacosctl apply config --file test-prod.yaml -n public -g PROD_GROUP
        if [ $? -eq 0 ]; then
          echo "  ✓ PROD_GROUP 分组配置创建成功"
        else
          echo "✗ PROD_GROUP 分组配置创建失败"
          exit 1
        fi

        # 获取配置并验证分组
        CONTENT=$(./nacosctl get config test-prod.yaml -n public -g PROD_GROUP)
        if echo "$CONTENT" | grep -q "PROD_GROUP"; then
          echo "  ✓ 分组配置获取成功"
        else
          echo "✗ 分组配置获取失败"
          exit 1
        fi

        # 清理
        ./nacosctl delete config test-prod.yaml -n public -g PROD_GROUP

        echo "✓ 命名空间和分组测试通过"

    - name: Test error handling
      run: |
        echo "=== 测试错误处理 ==="
        export NACOS_ADDR="http://localhost:8849/nacos"
        export NACOS_USERNAME="nacos"
        export NACOS_PASSWORD="nacos"

        # 测试获取不存在的配置
        echo "  → 测试获取不存在的配置"
        ./nacosctl get config nonexistent.yaml -n public 2>&1 | grep -q "config data not exist"
        if [ $? -eq 0 ]; then
          echo "  ✓ 正确返回 404 错误"
        else
          echo "✗ 错误处理不正确"
          exit 1
        fi

        # 测试错误的认证信息
        echo "  → 测试错误的认证信息"
        export NACOS_PASSWORD="wrongpassword"
        ./nacosctl get config -A -n public 2>&1 | grep -q "authentication failed\|failed to get access token"
        if [ $? -eq 0 ]; then
          echo "  ✓ 正确返回认证错误"
        else
          echo "✗ 认证错误处理不正确"
          exit 1
        fi

        echo "✓ 错误处理测试通过"

    - name: Run unit tests
      run: go test -v ./...

    - name: Cleanup test files
      if: always()
      run: |
        rm -f test-no-auth.yaml test-with-auth.yaml test.json test.properties test-prod.yaml
        rm -f /tmp/list-no-auth.txt /tmp/list-with-auth.txt

    - name: Docker logs on failure
      if: failure()
      run: |
        echo "=== Nacos No Auth Logs ==="
        docker logs nacos-no-auth 2>&1 | tail -50
        echo ""
        echo "=== Nacos With Auth Logs ==="
        docker logs nacos-with-auth 2>&1 | tail -50
        echo ""
        echo "=== Docker Compose Status ==="
        docker compose ps

    - name: Cleanup
      if: always()
      run: docker compose down -v
